import { __decorate } from "tslib";
import { Directive, HostBinding, ContentChildren } from '@angular/core';
import { EventService } from './event.service';
import { LightboxDirective } from './lightbox.directive';
import { CrystalLightbox } from './lightbox.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './event.service';
import * as ɵngcc2 from './lightbox.service';
let LightboxGroupDirective = class LightboxGroupDirective {
    constructor(eventService, lightbox) {
        this.eventService = eventService;
        this.lightbox = lightbox;
        this.thumbnailImages = [];
        this.images = [];
        this.properties = {};
        this.hostLightboxGroup = true;
        this.globalEventsSubscription = this.eventService.emitter.subscribe((event) => {
            this.handleGlobalEvents(event);
        });
    }
    get lightboxDirectiveList() {
        if (this._lightboxDirectiveList) {
            return this._lightboxDirectiveList.toArray();
        }
        else {
            return [];
        }
    }
    handleGlobalEvents(event) {
        if (event.type === 'thumbnail:click') {
            this.thumbnailImageElement = event.elementRef.nativeElement;
            this.thumbnailImages = this.getThumbnailImages();
            this.thumbnailImageIndex = this.getThumbnailImageIndex(this.thumbnailImageElement);
            if (this.thumbnailImageIndex == undefined) {
                return;
            }
            this.thumbnailLightboxDirective = this.getThumbnailLightboxDirective(this.thumbnailImageIndex);
            this.images = this.getImages();
            this.properties = event.properties;
            this.properties.index = this.thumbnailImageIndex;
            this.lightbox.open({
                images: this.images,
                //index: this.thumbnailImageIndex,
                properties: this.properties
            });
        }
    }
    getThumbnailImageIndex(element) {
        const images = this.thumbnailImages;
        for (var i = 0; i < images.length; i++) {
            if (element === images[i]) {
                return i;
            }
        }
    }
    getThumbnailLightboxDirective(index) {
        return this.lightboxDirectiveList[index];
    }
    getThumbnailImages() {
        let thumbnailImages = [];
        this.lightboxDirectiveList.forEach(el => {
            thumbnailImages.push(el['elementRef'].nativeElement);
        });
        return thumbnailImages;
    }
    getImages() {
        let images = [];
        this.lightboxDirectiveList.forEach(el => {
            let image = {};
            const nativeElement = el['elementRef'].nativeElement;
            if (el.fullImage) {
                image.fullImage = el.fullImage;
            }
            image.thumbnailImage = {
                path: nativeElement.src,
                height: nativeElement.naturalHeight,
                width: nativeElement.naturalWidth
            };
            image.nativeElement = nativeElement;
            images.push(image);
        });
        return images;
    }
};
LightboxGroupDirective.ɵfac = function LightboxGroupDirective_Factory(t) { return new (t || LightboxGroupDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.EventService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.CrystalLightbox)); };
LightboxGroupDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: LightboxGroupDirective, selectors: [["", "lightbox-group", ""]], contentQueries: function LightboxGroupDirective_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, LightboxDirective, 1);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx._lightboxDirectiveList = _t);
    } }, hostVars: 2, hostBindings: function LightboxGroupDirective_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("lightbox-group", ctx.hostLightboxGroup);
    } } });
LightboxGroupDirective.ctorParameters = () => [
    { type: EventService },
    { type: CrystalLightbox }
];
__decorate([
    HostBinding('class.lightbox-group')
], LightboxGroupDirective.prototype, "hostLightboxGroup", void 0);
__decorate([
    ContentChildren(LightboxDirective, { descendants: true })
], LightboxGroupDirective.prototype, "_lightboxDirectiveList", void 0);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(LightboxGroupDirective, [{
        type: Directive,
        args: [{
                selector: '[lightbox-group]'
            }]
    }], function () { return [{ type: ɵngcc1.EventService }, { type: ɵngcc2.CrystalLightbox }]; }, { hostLightboxGroup: [{
            type: HostBinding,
            args: ['class.lightbox-group']
        }], _lightboxDirectiveList: [{
            type: ContentChildren,
            args: [LightboxDirective, { descendants: true }]
        }] }); })();
export { LightboxGroupDirective };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlnaHRib3gtZ3JvdXAuZGlyZWN0aXZlLmpzIiwic291cmNlcyI6WyJAY3J5c3RhbHVpL2FuZ3VsYXItbGlnaHRib3gvbGliL2xpZ2h0Ym94LWdyb3VwLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUF5QixNQUFNLGVBQWUsQ0FBQztBQUMvRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQUssc0JBQXNCLENBQUE7QUFDdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFLLG9CQUFvQixDQUFDOzs7O0FBT3BELElBQWEsc0JBQXNCLEdBQW5DLE1BQWEsc0JBQXNCO0FBQ2xDLElBa0JHLFlBQ1ksWUFBMEIsRUFDMUIsUUFBeUI7QUFFekMsUUFIZ0IsaUJBQVksR0FBWixZQUFZLENBQWM7QUFDMUMsUUFBZ0IsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7QUFBRSxRQWpCdkMsb0JBQWUsR0FBRyxFQUFFLENBQUM7QUFDeEIsUUFBRyxXQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2YsUUFBRyxlQUFVLEdBQWUsRUFBRSxDQUFDO0FBQ2hDLFFBVXlDLHNCQUFpQixHQUFZLElBQUksQ0FBQztBQUMxRSxRQUtPLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQy9ELENBQUMsS0FBSyxFQUFFLEVBQUU7QUFDckIsWUFBZSxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDL0MsUUFBWSxDQUFDLENBQ0osQ0FBQztBQUNULElBQUcsQ0FBQztBQUVMLElBckJJLElBQUkscUJBQXFCO0FBQzNCLFFBQU0sSUFBSSxJQUFJLENBQUMsc0JBQXNCLEVBQUM7QUFDdkMsWUFBVyxPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN4RCxTQUFRO0FBQUUsYUFBSTtBQUNkLFlBQVcsT0FBTyxFQUFFLENBQUM7QUFDckIsU0FBUTtBQUNSLElBQUcsQ0FBQztBQUVMLElBYUksa0JBQWtCLENBQUMsS0FBSztBQUMxQixRQUFNLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxpQkFBaUIsRUFBQztBQUM1QyxZQUFXLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztBQUN2RSxZQUFXLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7QUFDNUQsWUFBVyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBRS9GLFlBQVksSUFBSSxJQUFJLENBQUMsbUJBQW1CLElBQUksU0FBUyxFQUFDO0FBQ3JELGdCQUFlLE9BQU87QUFDdEIsYUFBWTtBQUViLFlBQVksSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUMxRyxZQUFXLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQzFDLFlBQVcsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDO0FBQzlDLFlBQVcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDO0FBRTdELFlBQVksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7QUFDOUIsZ0JBQWUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO0FBQ2xDLGdCQUFlLGtDQUFrQztBQUNqRCxnQkFBZSxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7QUFDMUMsYUFBWSxDQUFDLENBQUM7QUFDZCxTQUFRO0FBQ1IsSUFBRyxDQUFDO0FBRUwsSUFBSSxzQkFBc0IsQ0FBQyxPQUFPO0FBQ2hDLFFBQU0sTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztBQUMzQyxRQUFPLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQy9DLFlBQVcsSUFBSSxPQUFPLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFDO0FBQ3JDLGdCQUFlLE9BQU8sQ0FBQyxDQUFDO0FBQ3hCLGFBQVk7QUFDWixTQUFRO0FBQ1IsSUFBRyxDQUFDO0FBRUwsSUFBSSw2QkFBNkIsQ0FBQyxLQUFLO0FBQ3JDLFFBQU0sT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDaEQsSUFBRyxDQUFDO0FBRUwsSUFBSSxrQkFBa0I7QUFDcEIsUUFBTSxJQUFJLGVBQWUsR0FBRyxFQUFFLENBQUM7QUFDaEMsUUFBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQy9DLFlBQVcsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDaEUsUUFBTyxDQUFDLENBQUMsQ0FBQztBQUNWLFFBQU8sT0FBTyxlQUFlLENBQUM7QUFDOUIsSUFBRyxDQUFDO0FBRUwsSUFBSSxTQUFTO0FBQ1gsUUFBTSxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDdkIsUUFBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQy9DLFlBQVcsSUFBSSxLQUFLLEdBQWtCLEVBQUUsQ0FBQztBQUN6QyxZQUFXLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxhQUFhLENBQUM7QUFFakUsWUFBWSxJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUM7QUFDNUIsZ0JBQWUsS0FBSyxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDO0FBQzlDLGFBQVk7QUFFYixZQUFZLEtBQUssQ0FBQyxjQUFjLEdBQUc7QUFDbEMsZ0JBQWUsSUFBSSxFQUFFLGFBQWEsQ0FBQyxHQUFHO0FBQ3RDLGdCQUFlLE1BQU0sRUFBRSxhQUFhLENBQUMsYUFBYTtBQUNsRCxnQkFBZSxLQUFLLEVBQUUsYUFBYSxDQUFDLFlBQVk7QUFDaEQsYUFBWSxDQUFBO0FBRWIsWUFBWSxLQUFLLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztBQUMvQyxZQUFXLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDOUIsUUFBTyxDQUFDLENBQUMsQ0FBQztBQUVYLFFBQVEsT0FBTyxNQUFNLENBQUM7QUFDckIsSUFBRyxDQUFDO0FBQ0osQ0FBQTs7Ozs7Ozs7O1dBQUE7QUFDQTtBQUFpRCxZQTdFcEIsWUFBWTtBQUN2QyxZQUF1QixlQUFlO0FBQ3pDO0FBTHlDO0FBQWMsSUFBbEQsV0FBVyxDQUFDLHNCQUFzQixDQUFDO0FBQUUsaUVBQWlDO0FBQ2Q7QUFBYyxJQUF0RSxlQUFlLENBQUMsaUJBQWlCLEVBQUUsRUFBQyxXQUFXLEVBQUUsSUFBSSxFQUFDLENBQUM7QUFBRSxzRUFBb0Q7Q0FsQnJHLHNCQUFzQixxQkFKbEMsU0FBUyxDQUFDLFdBQ1AsUUFBUSxFQUFFLGtCQUFrQixPQUMvQixDQUFDLEtBRVc7VUFBc0IsQ0FnR2xDOzs7Ozs7Ozs7O29CQUNEOztBQTNHQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFPQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFtQkEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQURBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBakJBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQVdBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFNQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQW5CQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFlQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUE1RUEsQUFBQSxBQUNBLEFBQUEsQUFKQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBbEJBLEFBQUEsQUFKQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBZ0dBLEFBaEdBLEFBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEhvc3RCaW5kaW5nLCBDb250ZW50Q2hpbGRyZW4sIFF1ZXJ5TGlzdCwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRXZlbnRTZXJ2aWNlIH0gZnJvbSAnLi9ldmVudC5zZXJ2aWNlJztcbmltcG9ydCB7IExpZ2h0Ym94RGlyZWN0aXZlIH0gZnJvbScuL2xpZ2h0Ym94LmRpcmVjdGl2ZScgXG5pbXBvcnQgeyBDcnlzdGFsTGlnaHRib3ggfSBmcm9tJy4vbGlnaHRib3guc2VydmljZSc7XG5pbXBvcnQgeyBQcm9wZXJ0aWVzLCBJbWFnZUV4dGVuZGVkIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbbGlnaHRib3gtZ3JvdXBdJ1xufSlcblxuZXhwb3J0IGNsYXNzIExpZ2h0Ym94R3JvdXBEaXJlY3RpdmUge1xuICAgIHRodW1ibmFpbEltYWdlRWxlbWVudDtcbiAgICB0aHVtYm5haWxMaWdodGJveERpcmVjdGl2ZTogTGlnaHRib3hEaXJlY3RpdmU7XG4gICAgdGh1bWJuYWlsSW1hZ2VJbmRleDogbnVtYmVyO1xuICAgIHRodW1ibmFpbEltYWdlcyA9IFtdO1xuICAgIGltYWdlcyA9IFtdO1xuICAgIHByb3BlcnRpZXM6IFByb3BlcnRpZXMgPSB7fTsgXG4gICAgZ2xvYmFsRXZlbnRzU3Vic2NyaXB0aW9uO1xuXG4gICAgZ2V0IGxpZ2h0Ym94RGlyZWN0aXZlTGlzdCgpe1xuICAgICAgICBpZiAodGhpcy5fbGlnaHRib3hEaXJlY3RpdmVMaXN0KXtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9saWdodGJveERpcmVjdGl2ZUxpc3QudG9BcnJheSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgQEhvc3RCaW5kaW5nKCdjbGFzcy5saWdodGJveC1ncm91cCcpIGhvc3RMaWdodGJveEdyb3VwOiBib29sZWFuID0gdHJ1ZTtcbiAgICBAQ29udGVudENoaWxkcmVuKExpZ2h0Ym94RGlyZWN0aXZlLCB7ZGVzY2VuZGFudHM6IHRydWV9KSBfbGlnaHRib3hEaXJlY3RpdmVMaXN0OiBRdWVyeUxpc3Q8TGlnaHRib3hEaXJlY3RpdmU+OyBcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBldmVudFNlcnZpY2U6IEV2ZW50U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBsaWdodGJveDogQ3J5c3RhbExpZ2h0Ym94KSB7XG5cbiAgICAgICAgdGhpcy5nbG9iYWxFdmVudHNTdWJzY3JpcHRpb24gPSB0aGlzLmV2ZW50U2VydmljZS5lbWl0dGVyLnN1YnNjcmliZShcbiAgICAgICAgICAgIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlR2xvYmFsRXZlbnRzKGV2ZW50KTsgXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaGFuZGxlR2xvYmFsRXZlbnRzKGV2ZW50KXtcbiAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICd0aHVtYm5haWw6Y2xpY2snKXtcbiAgICAgICAgICAgIHRoaXMudGh1bWJuYWlsSW1hZ2VFbGVtZW50ID0gZXZlbnQuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICAgICAgICAgICAgdGhpcy50aHVtYm5haWxJbWFnZXMgPSB0aGlzLmdldFRodW1ibmFpbEltYWdlcygpO1xuICAgICAgICAgICAgdGhpcy50aHVtYm5haWxJbWFnZUluZGV4ID0gdGhpcy5nZXRUaHVtYm5haWxJbWFnZUluZGV4KHRoaXMudGh1bWJuYWlsSW1hZ2VFbGVtZW50KTtcblxuICAgICAgICAgICAgaWYgKHRoaXMudGh1bWJuYWlsSW1hZ2VJbmRleCA9PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy50aHVtYm5haWxMaWdodGJveERpcmVjdGl2ZSA9IHRoaXMuZ2V0VGh1bWJuYWlsTGlnaHRib3hEaXJlY3RpdmUodGhpcy50aHVtYm5haWxJbWFnZUluZGV4KTtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VzID0gdGhpcy5nZXRJbWFnZXMoKTtcbiAgICAgICAgICAgIHRoaXMucHJvcGVydGllcyA9IGV2ZW50LnByb3BlcnRpZXM7XG4gICAgICAgICAgICB0aGlzLnByb3BlcnRpZXMuaW5kZXggPSB0aGlzLnRodW1ibmFpbEltYWdlSW5kZXg7XG5cbiAgICAgICAgICAgIHRoaXMubGlnaHRib3gub3Blbih7XG4gICAgICAgICAgICAgICAgaW1hZ2VzOiB0aGlzLmltYWdlcyxcbiAgICAgICAgICAgICAgICAvL2luZGV4OiB0aGlzLnRodW1ibmFpbEltYWdlSW5kZXgsXG4gICAgICAgICAgICAgICAgcHJvcGVydGllczogdGhpcy5wcm9wZXJ0aWVzXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldFRodW1ibmFpbEltYWdlSW5kZXgoZWxlbWVudCl7XG4gICAgICAgIGNvbnN0IGltYWdlcyA9IHRoaXMudGh1bWJuYWlsSW1hZ2VzO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT09IGltYWdlc1tpXSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRUaHVtYm5haWxMaWdodGJveERpcmVjdGl2ZShpbmRleCl7XG4gICAgICAgIHJldHVybiB0aGlzLmxpZ2h0Ym94RGlyZWN0aXZlTGlzdFtpbmRleF07XG4gICAgfVxuXG4gICAgZ2V0VGh1bWJuYWlsSW1hZ2VzKCl7XG4gICAgICAgIGxldCB0aHVtYm5haWxJbWFnZXMgPSBbXTtcbiAgICAgICAgdGhpcy5saWdodGJveERpcmVjdGl2ZUxpc3QuZm9yRWFjaChlbCA9PiB7XG4gICAgICAgICAgICB0aHVtYm5haWxJbWFnZXMucHVzaChlbFsnZWxlbWVudFJlZiddLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRodW1ibmFpbEltYWdlcztcbiAgICB9XG5cbiAgICBnZXRJbWFnZXMoKXtcbiAgICAgICAgbGV0IGltYWdlcyA9IFtdO1xuICAgICAgICB0aGlzLmxpZ2h0Ym94RGlyZWN0aXZlTGlzdC5mb3JFYWNoKGVsID0+IHtcbiAgICAgICAgICAgIGxldCBpbWFnZTogSW1hZ2VFeHRlbmRlZCA9IHt9O1xuICAgICAgICAgICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IGVsWydlbGVtZW50UmVmJ10ubmF0aXZlRWxlbWVudDtcblxuICAgICAgICAgICAgaWYgKGVsLmZ1bGxJbWFnZSl7XG4gICAgICAgICAgICAgICAgaW1hZ2UuZnVsbEltYWdlID0gZWwuZnVsbEltYWdlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpbWFnZS50aHVtYm5haWxJbWFnZSA9IHtcbiAgICAgICAgICAgICAgICBwYXRoOiBuYXRpdmVFbGVtZW50LnNyYyxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IG5hdGl2ZUVsZW1lbnQubmF0dXJhbEhlaWdodCxcbiAgICAgICAgICAgICAgICB3aWR0aDogbmF0aXZlRWxlbWVudC5uYXR1cmFsV2lkdGhcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaW1hZ2UubmF0aXZlRWxlbWVudCA9IG5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgICAgICBpbWFnZXMucHVzaChpbWFnZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBpbWFnZXM7XG4gICAgfVxufVxuIl19