{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../modules/schematics/src/container/index.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Rule,\n  SchematicContext,\n  SchematicsException,\n  Tree,\n  chain,\n  externalSchematic,\n  apply,\n  applyTemplates,\n  url,\n  noop,\n  filter,\n  template,\n  move,\n  mergeWith,\n  MergeStrategy,\n} from '@angular-devkit/schematics';\nimport * as ts from 'typescript';\nimport {\n  stringUtils,\n  buildRelativePath,\n  insertImport,\n  NoopChange,\n  ReplaceChange,\n  InsertChange,\n  getProjectPath,\n  omit,\n  parseName,\n} from '@ngrx/schematics/schematics-core';\nimport { Schema as ContainerOptions } from './schema';\n\nfunction addStateToComponent(options: Partial<ContainerOptions>) {\n  return (host: Tree) => {\n    if (!options.state && !options.stateInterface) {\n      return host;\n    }\n\n    const statePath = `/${options.path}/${options.state}`;\n\n    if (options.state) {\n      if (!host.exists(statePath)) {\n        throw new Error(`The Specified state path ${statePath} does not exist`);\n      }\n    }\n\n    const componentPath =\n      `/${options.path}/` +\n      (options.flat ? '' : stringUtils.dasherize(options.name) + '/') +\n      stringUtils.dasherize(options.name) +\n      '.component.ts';\n\n    const text = host.read(componentPath);\n\n    if (text === null) {\n      throw new SchematicsException(`File ${componentPath} does not exist.`);\n    }\n\n    const sourceText = text.toString('utf-8');\n\n    const source = ts.createSourceFile(\n      componentPath,\n      sourceText,\n      ts.ScriptTarget.Latest,\n      true\n    );\n\n    const stateImportPath = buildRelativePath(componentPath, statePath);\n    const storeImport = insertImport(\n      source,\n      componentPath,\n      'Store',\n      '@ngrx/store'\n    );\n    const stateImport = options.state\n      ? insertImport(\n          source,\n          componentPath,\n          `* as fromStore`,\n          stateImportPath,\n          true\n        )\n      : new NoopChange();\n\n    const componentClass = source.statements.find(\n      (stm) => stm.kind === ts.SyntaxKind.ClassDeclaration\n    );\n    const component = componentClass as ts.ClassDeclaration;\n    const componentConstructor = component.members.find(\n      (member) => member.kind === ts.SyntaxKind.Constructor\n    );\n    const cmpCtr = componentConstructor as ts.ConstructorDeclaration;\n    const { pos } = cmpCtr;\n    const constructorText = cmpCtr.getText();\n    const [start, end] = constructorText.split('()');\n    const storeConstructor = [start, `(private store: Store)`, end].join('');\n    const constructorUpdate = new ReplaceChange(\n      componentPath,\n      pos,\n      `  ${constructorText}\\n\\n`,\n      `\\n\\n  ${storeConstructor}`\n    );\n\n    const changes = [storeImport, stateImport, constructorUpdate];\n    const recorder = host.beginUpdate(componentPath);\n\n    for (const change of changes) {\n      if (change instanceof InsertChange) {\n        recorder.insertLeft(change.pos, change.toAdd);\n      } else if (change instanceof ReplaceChange) {\n        recorder.remove(pos, change.oldText.length);\n        recorder.insertLeft(change.order, change.newText);\n      }\n    }\n\n    host.commitUpdate(recorder);\n\n    return host;\n  };\n}\n\nexport default function (options: ContainerOptions): Rule {\n  return (host: Tree, context: SchematicContext) => {\n    options.path = getProjectPath(host, options);\n\n    const parsedPath = parseName(options.path, options.name);\n    options.name = parsedPath.name;\n    options.path = parsedPath.path;\n\n    const opts = ['state', 'stateInterface'].reduce(\n      (current: Partial<ContainerOptions>, key) => {\n        return omit(current, key as any);\n      },\n      options\n    );\n\n    const templateSource = apply(\n      url(options.testDepth === 'unit' ? './files' : './integration-files'),\n      [\n        options.skipTests\n          ? filter((path) => !path.endsWith('.spec.ts.template'))\n          : noop(),\n        applyTemplates({\n          'if-flat': (s: string) => (options.flat ? '' : s),\n          ...stringUtils,\n          ...(options as object),\n        } as any),\n        move(parsedPath.path),\n      ]\n    );\n\n    // Remove all undefined values to use the schematic defaults (in angular.json or the Angular schema)\n    (Object.keys(opts) as (keyof ContainerOptions)[]).forEach((key) =>\n      opts[key] === undefined ? delete opts[key] : {}\n    );\n\n    return chain([\n      externalSchematic('@schematics/angular', 'component', {\n        ...opts,\n        skipTests: true,\n      }),\n      addStateToComponent(options),\n      mergeWith(templateSource),\n    ])(host, context);\n  };\n}\n"]}